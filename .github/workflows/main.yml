name: Pixel 5 A14 Kernel SUSFS Full Auto

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential curl flex g++-multilib gcc-multilib \
            git gnupg gperf libncurses5-dev libssl-dev libxml2-utils \
            lzop pngcrush rsync schedtool squashfs-tools xsltproc \
            zip zlib1g-dev python3 unzip wget

      # ==============================
      # Clone Kernel Source
      # ==============================
      - name: Clone Pixel 5 Kernel (Android 14)
        run: |
          git clone https://android.googlesource.com/device/google/redbull-kernel kernel
          cd kernel
          git checkout android14

      # ==============================
      # Inject KernelSU
      # ==============================
      - name: Inject KernelSU
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -

      # ==============================
      # Clone SUSFS
      # ==============================
      - name: Clone SUSFS
        run: |
          git clone https://github.com/sidex15/susfs.git

      - name: Apply SUSFS Patch (4.19)
        run: |
          cd kernel
          git apply ../susfs/kernel_patches/4.19/*.patch || true

      # ==============================
      # Clone Proton Clang
      # ==============================
      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang

      # ==============================
      # Build Kernel
      # ==============================
      - name: Build Kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export KBUILD_BUILD_USER=github
          export KBUILD_BUILD_HOST=actions
          export PATH=$(pwd)/clang/bin:$PATH

          cd kernel
          make O=out redbull_defconfig
          make -j$(nproc) O=out CC=clang

      # ==============================
      # Download Factory Image A14
      # ==============================
      - name: Download Pixel 5 Android 14 Factory Image
        run: |
          wget https://dl.google.com/dl/android/aosp/redfin-android14-factory.zip -O factory.zip
          unzip factory.zip
          cd redfin-*
          unzip image-redfin-*.zip

      # ==============================
      # Repack boot.img
      # ==============================
      - name: Repack boot.img
        run: |
          git clone https://github.com/topjohnwu/Magisk.git magisk
          cd magisk/tools
          ./magiskboot unpack ../../redfin-*/boot.img
          cp ../../kernel/out/arch/arm64/boot/Image.lz4-dtb kernel
          ./magiskboot repack ../../redfin-*/boot.img
          mv new-boot.img ../../../Pixel5-SUSFS-boot.img

      # ==============================
      # Build AnyKernel3 ZIP
      # ==============================
      - name: Build AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp kernel/out/arch/arm64/boot/Image.lz4-dtb AnyKernel3/
          cd AnyKernel3
          zip -r9 ../Pixel5-A14-SUSFS-Kernel.zip *

      # ==============================
      # Upload Artifacts
      # ==============================
      - name: Upload boot.img
        uses: actions/upload-artifact@v4
        with:
          name: Pixel5-SUSFS-Boot
          path: Pixel5-SUSFS-boot.img

      - name: Upload AnyKernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Pixel5-SUSFS-AnyKernel
          path: Pixel5-A14-SUSFS-Kernel.zip

      # ==============================
      # Create GitHub Release
      # ==============================
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Pixel5-SUSFS-${{ github.run_number }}
          files: |
            Pixel5-SUSFS-boot.img
            Pixel5-A14-SUSFS-Kernel.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
