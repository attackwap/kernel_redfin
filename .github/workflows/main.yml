name: Pixel5 A14 Kernel SUSFS (Lite)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # ==============================
      # Cleanup disk (WAJIB)
      # ==============================
      - name: Free Disk Space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo apt clean
          df -h

      # ==============================
      # Install dependencies (minimal)
      # ==============================
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential curl flex \
          git libncurses5-dev libssl-dev zip python3

      # ==============================
      # Clone Kernel (SHALLOW)
      # ==============================
      - name: Clone Pixel 5 Kernel A14
        run: |
          git clone --depth=1 \
            -b android-msm-redbull-4.19-android14 \
            https://android.googlesource.com/kernel/msm \
            kernel

      # ==============================
      # Inject KernelSU
      # ==============================
      - name: Inject KernelSU
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -

      # ==============================
      # Clone & Apply SUSFS (4.19)
      # ==============================
      - name: Clone SUSFS
        run: |
          git clone --depth=1 https://github.com/sidex15/susfs.git

      - name: Apply SUSFS Patch
        run: |
          cd kernel
          git apply ../susfs/kernel_patches/4.19/*.patch || true

      # ==============================
      # Clone Proton Clang (SHALLOW)
      # ==============================
      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang

      # ==============================
      # Build Kernel
      # ==============================
      - name: Build Kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export KBUILD_BUILD_USER=github
          export KBUILD_BUILD_HOST=actions
          export PATH=$(pwd)/clang/bin:$PATH

          cd kernel
          make O=out redbull_defconfig
          make -j$(nproc) O=out CC=clang

      # ==============================
      # Build AnyKernel3 ZIP
      # ==============================
      - name: Build AnyKernel3 ZIP
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cp kernel/out/arch/arm64/boot/Image.lz4-dtb AnyKernel3/
          cd AnyKernel3
          zip -r9 ../Pixel5-A14-SUSFS-Kernel.zip *

      # ==============================
      # Upload Artifact
      # ==============================
      - name: Upload Kernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Pixel5-A14-SUSFS-Kernel
          path: Pixel5-A14-SUSFS-Kernel.zip
